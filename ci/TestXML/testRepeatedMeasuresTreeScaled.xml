<?xml version="1.0" standalone="yes"?>
<beast>

    <taxa id="taxa">
        <taxon id="A">
            <attr name="X">10 NA 1 0</attr>
        </taxon>
        <taxon id="B">
            <attr name="X">NA NA 2 NA</attr>
        </taxon>
        <taxon id="C">
            <attr name="X">NA 0 NA NA</attr>
        </taxon>
        <taxon id="D">
            <attr name="X">-2 3 4 NA</attr>
        </taxon>
        <taxon id="E">
            <attr name="X">NA NA NA NA</attr>
        </taxon>
    </taxa>

    <newick id="tree" usingHeights="true" usingDates="false">
        ((A:1,(B:1,C:1):1):2,(D:1, E:2):1);
    </newick>

    <treeModel id="treeModel">
        <newick idref="tree"/>
        <rootHeight>
            <parameter id="treeModel.rootHeight"/>
        </rootHeight>
        <nodeHeights internalNodes="true">
            <parameter id="treeModel.internalNodeHeights"/>
        </nodeHeights>
        <nodeHeights internalNodes="true" rootNode="true">
            <parameter id="treeModel.allInternalNodeHeights"/>
        </nodeHeights>
        <nodeTraits name="X" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="4">
            <parameter id="leafTraits"/>
        </nodeTraits>
    </treeModel>

    <multivariateDiffusionModel id="diffusionModel">
        <precisionMatrix>
            <matrixParameter id="precisionMatrix">
                <parameter id="prec.col1" value="1.0 0.1 -0.5 -0.1"/>
                <parameter id="prec.col2" value="0.1 2.0 -0.6 -0.1"/>
                <parameter id="prec.col3" value="-0.5 -0.6 3.0 0.4"/>
                <parameter id="prec.col4" value="-0.1 -0.1 0.4 4.0"/>
            </matrixParameter>
        </precisionMatrix>
    </multivariateDiffusionModel>

    <repeatedMeasuresModel id="repeatedMeasures" traitName="X" scaleByTipHeight="true">
        <treeModel idref="treeModel"/>
        <traitParameter>
            <parameter idref="leafTraits"/>
        </traitParameter>
        <samplingPrecision>
            <cachedMatrixInverse id="sampling.precision.matrix">
                <compoundSymmetricMatrix id="sampling.variance.matrix" asCorrelation="true" isCholesky="true">
                    <diagonal>
                        <parameter id="sampling.variance.diagonal" value="1 0.01 10 0.1" lower="0"/>
                    </diagonal>
                    <offDiagonal>
                        <parameter id="sampling.variance.offDiagonal" value="0.1 0.2 0.3 -0.1 -0.2 -0.3"/>
                    </offDiagonal>
                </compoundSymmetricMatrix>
            </cachedMatrixInverse>
        </samplingPrecision>
        <multivariateDiffusionModel idref="diffusionModel"/>
    </repeatedMeasuresModel>

    <traitDataLikelihood id="traitLikelihood" traitName="X" forceFullPrecision="true" scaleByTime="true"
                         useTreeLength="false">
        <multivariateDiffusionModel idref="diffusionModel"/>
        <treeModel idref="treeModel"/>
        <repeatedMeasuresModel idref="repeatedMeasures"/>
        <conjugateRootPrior>
            <meanParameter>
                <parameter id="mean" value="0.0 0.0 0 0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="0.001"/>
            </priorSampleSize>
        </conjugateRootPrior>
    </traitDataLikelihood>

    <precisionGradient id="errorModel.gradient" parameter="diagonal" traitName="trait2">
        <repeatedMeasuresModel idref="repeatedMeasures"/>
        <traitDataLikelihood idref="traitLikelihood"/>
        <compoundSymmetricMatrix idref="sampling.precision.matrix"/>
    </precisionGradient>

    <report>
        <diffusionGradient idref="errorModel.gradient"/>
    </report>

    <assertEqual tolerance="1e-3" verbose="true">
        <message>
            Check log likelihood of observed data
        </message>
        <actual regex="logDatumLikelihood:\s+(.*)\n">
            <traitDataLikelihood idref="traitLikelihood"/>
        </actual>
        <expected>
            -57.937925254099724
        </expected>
    </assertEqual>

    <operators id="Operators">
        <dirtyLikelihood weight="1">
            <traitDataLikelihood idref="traitLikelihood"/>
        </dirtyLikelihood>
    </operators>

    <mcmc id="iouMcmc" chainLength="10">
        <posterior id="traitPosterior">
            <traitDataLikelihood idref="traitLikelihood"/>
        </posterior>
        <operators idref="Operators"/>
        <log logEvery="10">
            <posterior idref="traitPosterior"/>
        </log>
    </mcmc>

</beast>

