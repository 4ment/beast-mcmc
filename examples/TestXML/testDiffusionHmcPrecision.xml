<?xml version="1.0" standalone="yes"?>
<beast>

	<taxa id="taxa">
		<taxon id="A">
			<attr name="X">10 11 12</attr>
		</taxon>
		<taxon id="B">
			<attr name="X">2 3 4</attr>
		</taxon>
		<taxon id="C">
			<attr name="X">2 4 3</attr>
		</taxon>
	</taxa>

	<newick id="tree">
		((A:1.1,B:1.1):1,C:2.1);
	</newick>

	<treeModel id="treeModel">
		<newick idref="tree"/>
		<rootHeight>
			<parameter id="treeModel.rootHeight"/>
		</rootHeight>
		<nodeHeights internalNodes="true">
			<parameter id="treeModel.internalNodeHeights"/>
		</nodeHeights>
		<nodeHeights internalNodes="true" rootNode="true">
			<parameter id="treeModel.allInternalNodeHeights"/>
		</nodeHeights>
		<nodeTraits name="X" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="3">
			<parameter id="leafTraits"/>
		</nodeTraits>
	</treeModel>

    <multivariateDiffusionModel id="diffusionModel">
        <precisionMatrix>
            <compoundSymmetricMatrix id="precisionMatrix" asCorrelation="true" isCholesky="true">
                <diagonal>
                    <parameter id="precision.diagonal" value="1.0 1.0 1.0" lower="0.0 0.0 0.0"/>
                </diagonal>
                <offDiagonal>
                    <parameter id="precision.correlation" value="0.0 0.0 0.0" />
                </offDiagonal>
            </compoundSymmetricMatrix>
        </precisionMatrix>
	</multivariateDiffusionModel>

	<traitDataLikelihood id="bmLikelihood" traitName="X" forceFullPrecision="true">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
     	<conjugateRootPrior>
            <meanParameter>
                <parameter id="meanRoot"  value="-3.0 -1.0 1.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter id="sampleSizeRoot" value="10.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
	</traitDataLikelihood>

    <!-- ************************************************** -->
    <!-- Correlation -->

    <precisionGradient id="precisionCorrelationGradient" parameter="precisionCorrelation">
        <wishartStatistics  traitName="X">
            <traitDataLikelihood idref="bmLikelihood"/>
        </wishartStatistics>
        <traitDataLikelihood idref="bmLikelihood"/>
        <compoundSymmetricMatrix idref="precisionMatrix"/>
    </precisionGradient>

	<operators id="bmOperators.correlation.hmcVanilla">
 		<hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
 			drawVariance="1.0">
 			<gradient idref="precisionCorrelationGradient"/>
			<parameter idref="precision.correlation"/>
            <LKJTransform dimension = "3"/>
 		</hamiltonianMonteCarloOperator>
	</operators>

	<operators id="bmOperators.correlation.randomWalk">
        <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="precision.correlation"/>
            <LKJTransform dimension = "3"/>
        </randomWalkOperator>
	</operators>

	<mcmc id="mcmc.correlation.hmcVanilla" chainLength="100000" autoOptimize="false">
		<posterior>
            <likelihood id="likelihood.correlation.hmcVanilla">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="precisionMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.correlation.hmcVanilla"/>

		<log logEvery="1000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.correlation.hmcVanilla"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="precisionMatrix"/>
			</column>
		</log>
		<log logEvery="100" fileName="testDiffusionCorrelationHmcVanilla.log">
				<likelihood idref="likelihood.correlation.hmcVanilla"/>
                <matrixParameter idref="precision.correlation"/>
		</log>
	</mcmc>

	<mcmc id="mcmc.correlation.randomWalk" chainLength="1000000" autoOptimize="false">
		<posterior>
            <likelihood id="likelihood.correlation.randomWalk">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="precisionMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.correlation.randomWalk"/>

		<log logEvery="10000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.correlation.randomWalk"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="precisionMatrix"/>
			</column>
		</log>
		<log logEvery="1000" fileName="testDiffusionCorrelationRandomWalk.log">
				<likelihood idref="likelihood.correlation.randomWalk"/>
                <matrixParameter idref="precision.correlation"/>
		</log>
	</mcmc>

	<report>
		<property name="timer">
			<object idref="mcmc.correlation.randomWalk"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionCorrelationRandomWalk.log" stdError="true"/>
	
	<report>
		<property name="timer">
			<object idref="mcmc.correlation.hmcVanilla"/>
		</property>
	</report>
	
	<traceAnalysis fileName="testDiffusionCorrelationHmcVanilla.log" stdError="true"/>

    <maximizeWrtParameter id="maximize.correlation"  nIteration="100" printToScreen="true">
        <densityWrtParameter>
            <traitDataLikelihood idref="bmLikelihood"/>
            <matrixParameter idref="precision.correlation"/>
        </densityWrtParameter>
        <LKJTransform  dimension = "3"/>
    </maximizeWrtParameter>

    <report>
        <maximizeWrtParameter idref="maximize.correlation"/> 
    </report>

<!--

burnIn   <= 100000,   maxState  = 1000000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.correlation.randomWalk   -21.2659    1.3063  -20.9035    -23.7866    -19.756 901 -20.9821    -19.8559    
precision.correlation1  -0.6402 0.0942  -0.6481 -0.8275 -0.4743 901 -0.7248 -0.6042 
precision.correlation2  -0.4573 0.1202  -0.4617 -0.6929 -0.2378 901 -0.551  -0.3949 
precision.correlation3  -0.8309 0.0685  -0.8402 -0.9472 -0.7034 901 -0.9022 -0.814  

burnIn   <= 10000,   maxState  = 100000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.correlation.hmcVanilla   -21.2321    1.2277  -20.8871    -23.7126    -19.7818    901 -20.9194    -19.8375    
precision.correlation1  -0.644  0.0881  -0.6489 -0.8035 -0.4719 885.1466    -0.718  -0.5987 
precision.correlation2  -0.4539 0.1194  -0.4568 -0.6926 -0.2223 901 -0.528  -0.3728 
precision.correlation3  -0.8319 0.0684  -0.8383 -0.9578 -0.6974 901 -0.8917 -0.8055 
-->

    <!-- ************************************************** -->
    <!-- Diagonal -->

    <precisionGradient id="precisionDiagonalGradient" parameter="precisionDiagonal">
        <wishartStatistics  traitName="X">
            <traitDataLikelihood idref="bmLikelihood"/>
        </wishartStatistics>
        <traitDataLikelihood idref="bmLikelihood"/>
        <compoundSymmetricMatrix idref="precisionMatrix"/>
    </precisionGradient>

	<operators id="bmOperators.diagonal.hmcVanilla">
 		<hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
 			drawVariance="1.0">
 			<gradient idref="precisionDiagonalGradient"/>
            <parameter idref="precision.diagonal"/>
 		</hamiltonianMonteCarloOperator>
	</operators>

	<operators id="bmOperators.diagonal.randomWalk">
        <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="precision.diagonal"/>
        </randomWalkOperator>
	</operators>

	<mcmc id="mcmc.diagonal.randomWalk" chainLength="1000000" autoOptimize="false">
		<posterior>
            <likelihood id="likelihood.diagonal.randomWalk">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="precisionMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.diagonal.randomWalk"/>

		<log logEvery="10000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.diagonal.randomWalk"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="precisionMatrix"/>
			</column>
		</log>
		<log logEvery="1000" fileName="testDiffusionDiagonalRandomWalk.log">
				<likelihood idref="likelihood.diagonal.randomWalk"/>
                <matrixParameter idref="precision.diagonal"/>
		</log>
	</mcmc>

	<mcmc id="mcmc.diagonal.hmcVanilla" chainLength="100000" autoOptimize="false">
		<posterior>
            <likelihood id="likelihood.diagonal.hmcVanilla">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="precisionMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.diagonal.hmcVanilla"/>

		<log logEvery="1000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.diagonal.hmcVanilla"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="precisionMatrix"/>
			</column>
		</log>
		<log logEvery="100" fileName="testDiffusionDiagonalHmcVanilla.log">
				<likelihood idref="likelihood.diagonal.hmcVanilla"/>
                <matrixParameter idref="precision.diagonal"/>
		</log>
	</mcmc>

	<report>
		<property name="timer">
			<object idref="mcmc.diagonal.randomWalk"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionDiagonalRandomWalk.log" stdError="true"/>
	
	<report>
		<property name="timer">
			<object idref="mcmc.diagonal.hmcVanilla"/>
		</property>
	</report>
	
	<traceAnalysis fileName="testDiffusionDiagonalHmcVanilla.log" stdError="true"/>

    <maximizeWrtParameter id="maximize.diagonal"  nIteration="100" printToScreen="true">
        <densityWrtParameter>
            <traitDataLikelihood idref="bmLikelihood"/>
            <paramter idref="precision.diagonal"/>
        </densityWrtParameter>
        <signTransform>
            <paramter idref="precision.diagonal"/>
        </signTransform>
    </maximizeWrtParameter>

    <report>
        <maximizeWrtParameter idref="maximize.diagonal"/> 
    </report>

<!--
burnIn   <= 100000,   maxState  = 1000000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.diagonal.randomWalk  -21.6665    1.3689  -21.3554    -24.5361    -19.9241    896.5488    -21.5338    -20.1595    
precision.diagonal1 1.5632  0.6321  1.4925  0.5647  2.9091  747.9767    0.9358  1.7495  
precision.diagonal2 1.8745  0.7588  1.7984  0.7024  3.4601  649.5262    1.1737  2.1515  
precision.diagonal3 2.2155  0.907   2.0761  0.7348  3.9479  763.6206    1.3899  2.5428  

burnIn   <= 10000,   maxState  = 100000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.diagonal.hmcVanilla  -21.7098    1.3899  -21.3931    -24.4427    -19.9449    142.6371    -21.471 -20.0756    
precision.diagonal1 1.5467  0.665   1.4512  0.4173  2.8261  127.0657    0.9646  1.7899  
precision.diagonal2 1.8352  0.7529  1.7541  0.4997  3.2793  85.7296 1.1177  2.0961  *
precision.diagonal3 2.2212  0.9211  2.0922  0.6555  3.9722  92.5297 1.3705  2.5848  *
-->
</beast>

