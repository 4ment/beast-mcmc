<?xml version="1.0" standalone="yes"?>
<beast>

    <taxa id="taxa">
		<taxon id="t16"> <attr name="simTrait"> -1.08620104981184 -1.08188574777903 -0.392988209152307 -1.97078575189441 </attr> </taxon>
		<taxon id="t21"> <attr name="simTrait"> -0.902052941041434 -0.216172072304104 -0.523365635961216 -1.13048406475673 </attr> </taxon>
		<taxon id="t49"> <attr name="simTrait"> -0.0978687057347054 0.111645313187048 0.35717114067549 2.09724374599856 </attr> </taxon>
		<taxon id="t37"> <attr name="simTrait"> -0.990989240876509 0.513769057773718 0.378432188338339 0.503426051493209 </attr> </taxon>
		<taxon id="t12"> <attr name="simTrait"> -1.05753668628049 1.16843539835522 1.65899853234237 0.798085335027943 </attr> </taxon>
		<taxon id="t45"> <attr name="simTrait"> -0.694910470904697 0.269651267358283 0.680099731378929 0.255015586125871 </attr> </taxon>
		<taxon id="t36"> <attr name="simTrait"> -0.676948542433985 0.357673025916996 0.379738101635482 0.0441308889106263 </attr> </taxon>
		<taxon id="t48"> <attr name="simTrait"> -0.281611727272804 0.000785910322963814 0.770078540164318 1.44965748876908 </attr> </taxon>
		<taxon id="t7"> <attr name="simTrait"> -0.634122808624146 0.0491524638951258 0.763156724826932 0.447561983276782 </attr> </taxon>
		<taxon id="t40"> <attr name="simTrait"> -0.923873290506427 -0.26969423975416 0.667164642864906 0.200921954255138 </attr> </taxon>
		<taxon id="t24"> <attr name="simTrait"> -0.441973921264739 0.128358842729872 0.782766038035235 -0.124178704396332 </attr> </taxon>
		<taxon id="t35"> <attr name="simTrait"> -0.747736338894237 -0.00551855153545189 1.12228620935886 0.911544906287326 </attr> </taxon>
		<taxon id="t47"> <attr name="simTrait"> -0.250614524028038 0.432744433971853 0.447058146821746 1.03095700915197 </attr> </taxon>
		<taxon id="t5"> <attr name="simTrait"> -0.369377459008747 0.270206225691939 0.523407032155764 0.590259033980869 </attr> </taxon>
		<taxon id="t34"> <attr name="simTrait"> -0.528022299227884 0.256679921715153 0.606437941014327 0.524151913031445 </attr> </taxon>
		<taxon id="t33"> <attr name="simTrait"> -0.280847744456183 -0.0368668111405211 1.26093027441034 0.624560001041951 </attr> </taxon>
		<taxon id="t9"> <attr name="simTrait"> -0.239624882883438 -0.415267345367156 1.25761350568151 0.0440831206758578 </attr> </taxon>
		<taxon id="t4"> <attr name="simTrait"> -0.310176337766947 0.215472502085723 0.652144794762461 -0.369290763539728 </attr> </taxon>
		<taxon id="t42"> <attr name="simTrait"> -0.323812545218568 -0.0653273358975892 1.53850356703654 -0.0968046148394724 </attr> </taxon>
		<taxon id="t46"> <attr name="simTrait"> -0.891961273477434 0.527035897729816 1.34922201455852 0.581185694344926 </attr> </taxon>
		<taxon id="t23"> <attr name="simTrait"> -0.739035967676036 0.738784059709959 0.917186767846983 0.454491974538363 </attr> </taxon>
		<taxon id="t32"> <attr name="simTrait"> -0.619836247916223 0.541841304027812 0.8599594744769 0.27552159209529 </attr> </taxon>
		<taxon id="t8"> <attr name="simTrait"> -0.707268012851914 -1.20733748976303 0.136692764473181 -0.181921749640516 </attr> </taxon>
		<taxon id="t18"> <attr name="simTrait"> -0.59587995177198 -0.741219637385581 -0.00501984252618998 0.193590252112044 </attr> </taxon>
		<taxon id="t41"> <attr name="simTrait"> -0.610527586551701 -0.979620501537813 -0.0928794140929769 -0.0894037330622636 </attr> </taxon>
		<taxon id="t31"> <attr name="simTrait"> -1.47209055605592 -1.24077598464091 0.292298974006678 -0.854718835452826 </attr> </taxon>
		<taxon id="t50"> <attr name="simTrait"> -1.44259056530182 0.533404001774868 0.452558309081694 0.0147323903890552 </attr> </taxon>
		<taxon id="t28"> <attr name="simTrait"> -1.74481554931826 0.165486530626398 -1.10293209222341 -0.646607874140994 </attr> </taxon>
		<taxon id="t14"> <attr name="simTrait"> -1.78763583302449 -0.273620327461392 -0.856709215940586 -0.752047705720689 </attr> </taxon>
		<taxon id="t3"> <attr name="simTrait"> -1.78586052415914 -0.187300391638962 -1.71305351764589 -0.52534589962875 </attr> </taxon>
		<taxon id="t25"> <attr name="simTrait"> -1.55994116127519 -0.421666664603688 -2.16249953439676 -0.0862309334236758 </attr> </taxon>
		<taxon id="t10"> <attr name="simTrait"> -1.5791550981495 0.538247495368806 -0.688352800592518 -0.217494578915797 </attr> </taxon>
		<taxon id="t27"> <attr name="simTrait"> -1.91567136231097 0.85718541508941 -0.665439149094541 0.403132946458187 </attr> </taxon>
		<taxon id="t11"> <attr name="simTrait"> -1.95085864915934 0.715260942860833 -1.00270564776376 0.380666751189034 </attr> </taxon>
		<taxon id="t22"> <attr name="simTrait"> -1.34290770012515 0.235257282253894 -0.533258224777956 -0.915124550674635 </attr> </taxon>
		<taxon id="t39"> <attr name="simTrait"> -1.42843196982816 0.3939688290558 -0.368660025552845 -1.32488727349222 </attr> </taxon>
		<taxon id="t1"> <attr name="simTrait"> -1.97729187841943 0.477721497541329 0.00848024268219898 -0.689203772555105 </attr> </taxon>
		<taxon id="t43"> <attr name="simTrait"> -2.00347883300913 0.700089299095528 0.899645767861542 -0.585199335050258 </attr> </taxon>
		<taxon id="t20"> <attr name="simTrait"> -1.80314318814088 -1.34472380112995 0.493329502864596 0.211509216772147 </attr> </taxon>
		<taxon id="t30"> <attr name="simTrait"> -1.81923153584802 -1.18319798600553 1.10159155559943 0.423440492029117 </attr> </taxon>
		<taxon id="t2"> <attr name="simTrait"> -2.61729067131548 -1.13760268196271 1.23478086183715 -1.04852727597032 </attr> </taxon>
		<taxon id="t17"> <attr name="simTrait"> -0.393893663071797 0.295668972575418 -0.424922794305813 1.53938267382437 </attr> </taxon>
		<taxon id="t38"> <attr name="simTrait"> -0.320392992738582 0.35914668100999 -0.021776600808329 1.46490931569901 </attr> </taxon>
		<taxon id="t26"> <attr name="simTrait"> -1.16144276655973 -0.193216013303451 0.371339755065459 -0.838607136302574 </attr> </taxon>
		<taxon id="t13"> <attr name="simTrait"> -0.768140117915604 -0.00886631166249681 0.00749290339419534 -0.200452854205651 </attr> </taxon>
		<taxon id="t19"> <attr name="simTrait"> -0.527439016389196 0.304829566161456 0.48767396383133 0.0464919510148916 </attr> </taxon>
		<taxon id="t15"> <attr name="simTrait"> -0.365169271786662 -0.333230170342726 -1.36823593918816 -0.679266668431622 </attr> </taxon>
		<taxon id="t29"> <attr name="simTrait"> -0.748410563867927 -0.0658632381218594 -0.893490158776143 -0.732847604082649 </attr> </taxon>
		<taxon id="t44"> <attr name="simTrait"> -0.28300984160117 -0.77770467526985 -0.634579766600907 -0.352547003962922 </attr> </taxon>
		<taxon id="t6"> <attr name="simTrait"> -0.417391506054772 0.0904761071103364 0.149501767857483 0.619905078512765 </attr> </taxon>
    </taxa>

	<newick id="tree" usingHeights="true" usingDates="false">
		(((t16:0.2669120944,(t21:0.1179767583,(t49:0.1377510131,((t37:0.06888311066,t12:0.1027487536):0.01891150883,(t45:0.03050371596,(((((t36:0.07604341532,(t48:0.01830071082,t7:0.01010980547):0.0008062216752):0.04581388327,t40:0.05522025861):0.04578831428,t24:0.06092992921):0.01533072851,((t35:0.05924853423,t47:0.005306019884):0.04469822675,t5:0.004070003068):0.018820849):0.02662104855,((t34:0.00307900863,((t33:0.02881359051,t9:0.04366350786):0.03754202354,t4:0.02745630653):0.02622853521):0.004047393042,((t42:0.09475016404,t46:0.07564130526):0.007645747663,(t23:0.01932723842,t32:0.006599979977):0.0002051294203):0.0164176812):0.0137406295):0.06637741739):0.002114571876):0.1074137178):0.03003012592):0.127976066):0.1753643411,((t8:0.01254122802,t18:0.01065390812):0.007291049339,t41:0.04894641794):0.3922824419):0.2306052858,((t31:0.158422386,(((t50:0.04081005031,(((t28:0.1044515193,(t14:0.007424130149,(t3:0.02313741978,t25:0.08821028243):0.04187188865):0.1160045377):0.001411434832,(t10:0.001459638691,(t27:0.05479100855,t11:0.01035830197):0.07769644802):0.06272894016):0.01386010626,((t22:0.0523116194,t39:0.01756513333):0.06777870016,t1:0.01011313611):0.03235599305):0.01180315468):0.0178968221,t43:0.03917824983):0.1105892694,(t20:0.04533417192,(t30:0.03758788288,t2:0.1076004859):0.006037492264):0.2390785222):0.008898533427):0.08114893383,(((t17:0.01438626946,t38:0.006045402167):0.09946179619,((t26:0.09837701357,t13:0.004843558083):0.0003468517638,(((t19:0.1433988181,t15:0.0297955862):0.003772104913,t29:0.03417430552):0.03488924101,t44:0.0284976228):0.08178307643):0.09219037346):0.02379393721,t6:0.02295576132):0.1429955332):0.4771769157);
    </newick>

	<treeModel id="treeModel">
		<newick idref="tree"/>
		<rootHeight>
			<parameter id="treeModel.rootHeight"/>
		</rootHeight>
		<nodeHeights internalNodes="true">
			<parameter id="treeModel.internalNodeHeights"/>
		</nodeHeights>
		<nodeHeights internalNodes="true" rootNode="true">
			<parameter id="treeModel.allInternalNodeHeights"/>
		</nodeHeights>
		<nodeTraits name="simTrait" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="4">
			<parameter id="leafTraits"/>
		</nodeTraits>
	</treeModel>

    <multivariateDiffusionModel id="diffusionModel">
        <precisionMatrix>
        	<cachedMatrixInverse id="precisionMatrix">
	            <compoundSymmetricMatrix id="varianceMatrix" asCorrelation="true" isCholesky="true">
    	            <diagonal>
        	            <parameter id="variance.diagonal" value="1.0 2.0 3.0 4.0" lower="0.0 0.0 0.0 0.0"/>
            	    </diagonal>
	                <offDiagonal>
    	                <parameter id="variance.correlation" value="0.01 0.02 0.03 0.04 0.05 0.06" />
	                </offDiagonal>
	            </compoundSymmetricMatrix>
	        </cachedMatrixInverse>
    	</precisionMatrix>
	</multivariateDiffusionModel>

	<report>
		<compoundSymetricMatrix idref="varianceMatrix"/>
		<cachedMatrixInverse idref="precisionMatrix"/>
	</report>

	<traitDataLikelihood id="bmLikelihood" traitName="simTrait" forceFullPrecision="true" allowSingular="true">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
     	<conjugateRootPrior>
            <meanParameter>
                <parameter id="meanRoot"  value="0.0 0.0 0.0 0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter id="sampleSizeRoot" value="2.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
	</traitDataLikelihood>

    <!-- ************************************************** -->
    <!-- Correlation -->

    <precisionGradient id="precisionCorrelationGradient" parameter="correlation">
        <wishartStatistics  traitName="simTrait">
            <traitDataLikelihood idref="bmLikelihood"/>
        </wishartStatistics>
        <traitDataLikelihood idref="bmLikelihood"/>
        <cachedMatrixInverse idref="precisionMatrix"/>
    </precisionGradient>

    <LKJCorrelationPrior id="prior.cholesky" shapeParameter="1.0" dimension="4">
		<data>
            <parameter idref="variance.correlation"/>
		</data>
	</LKJCorrelationPrior>

	<operators id="bmOperators.correlation.hmcVanilla">
 		<hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
                                       drawVariance="1.0" gradientCheckCount="100" gradientCheckTolerance="0.5">
            <jointGradient>
                <gradient>
                    <distributionLikelihood idref="prior.cholesky"/>
                </gradient>
                <gradient idref="precisionCorrelationGradient"/>
            </jointGradient>
			<parameter idref="variance.correlation"/>
            <LKJTransform dimension = "4"/>
 		</hamiltonianMonteCarloOperator>
	</operators>

	<operators id="bmOperators.correlation.randomWalk">
        <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="variance.correlation"/>
            <LKJTransform dimension = "4"/>
        </randomWalkOperator>
	</operators>

	<mcmc id="mcmc.correlation.hmcVanilla" chainLength="100000" autoOptimize="false">
		<posterior>
            <prior>
                <LKJCorrelationPrior idref="prior.cholesky"/>
            </prior>
            <likelihood id="likelihood.correlation.hmcVanilla">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.correlation.hmcVanilla"/>
		<log logEvery="1000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.correlation.hmcVanilla"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <LKJCorrelationPrior idref="prior.cholesky"/>
			</column>
			<column label="variance" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="100" fileName="testDiffusionCorrelationHmcVanilla.log">
            <likelihood idref="likelihood.correlation.hmcVanilla"/>
            <LKJCorrelationPrior idref="prior.cholesky"/>
            <matrixParameter idref="variance.correlation"/>
		</log>
	</mcmc>


	<mcmc id="mcmc.correlation.randomWalk" chainLength="1000000" autoOptimize="false">
		<posterior>
            <prior>
                <LKJCorrelationPrior idref="prior.cholesky"/>
            </prior>
            <likelihood id="likelihood.correlation.randomWalk">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.correlation.randomWalk"/>
		<log logEvery="10000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.correlation.randomWalk"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <LKJCorrelationPrior idref="prior.cholesky"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="1000" fileName="testDiffusionCorrelationRandomWalk.log">
            <likelihood idref="likelihood.correlation.randomWalk"/>
            <LKJCorrelationPrior idref="prior.cholesky"/>
            <matrixParameter idref="variance.correlation"/>
		</log>
	</mcmc>

	<report>
		<property name="timer">
			<object idref="mcmc.correlation.randomWalk"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionCorrelationRandomWalk.log" stdError="true"/>

	<report>
		<property name="timer">
			<object idref="mcmc.correlation.hmcVanilla"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionCorrelationHmcVanilla.log" stdError="true"/>

    <maximizeWrtParameter id="maximize.correlation"  nIteration="100" printToScreen="true">
        <densityWrtParameter>
            <traitDataLikelihood idref="bmLikelihood"/>
            <matrixParameter idref="variance.correlation"/>
        </densityWrtParameter>
        <LKJTransform  dimension = "4"/>
    </maximizeWrtParameter>

    <report>
        <maximizeWrtParameter idref="maximize.correlation"/>
    </report>

<!--
burnIn   <= 100000,   maxState  = 1000000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.correlation.randomWalk   -123.0101   1.6022  -122.667    -126.1227   -120.4826   901 -123.199    -121.378    
prior.cholesky  -2.5404 0.052   -2.5319 -2.6403 -2.4599 901 -2.5427 -2.4812 
variance.correlation1   -0.1095 0.1336  -0.1186 -0.3484 0.1612  901 -0.2058 -0.0291 
variance.correlation2   -0.2067 0.126   -0.2093 -0.4551 0.0272  901 -0.3057 -0.1423 
variance.correlation3   0.3769  0.1069  0.3865  0.1569  0.5665  901 0.312   0.4506  
variance.correlation4   0.1259  0.1361  0.1312  -0.1439 0.3682  722.9558    0.0317  0.2157  
variance.correlation5   0.2906  0.1168  0.2955  0.0529  0.5092  901 0.2544  0.4053  
variance.correlation6   0.1218  0.1148  0.1247  -0.094  0.3486  901 0.0521  0.2031  

burnIn   <= 10000,   maxState  = 100000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.correlation.hmcVanilla   -123.1047   1.6807  -122.776    -126.4541   -120.3999   816.6535    -123.1416   -121.3005   
prior.cholesky  -2.5373 0.0545  -2.5248 -2.6484 -2.465  901 -2.5345 -2.4789 
variance.correlation1   -0.0944 0.1377  -0.096  -0.3635 0.1666  901 -0.1768 -0.0044 
variance.correlation2   -0.2023 0.1253  -0.2055 -0.4367 0.0368  896.716 -0.2735 -0.0984 
variance.correlation3   0.3821  0.1096  0.3879  0.1844  0.5935  901 0.3417  0.4857  
variance.correlation4   0.1208  0.1408  0.1264  -0.1661 0.3857  832.6905    0.0168  0.2051  
variance.correlation5   0.2922  0.1184  0.2974  0.0639  0.5095  901 0.2238  0.3824  
variance.correlation6   0.1269  0.1124  0.1294  -0.0696 0.3651  812.5957    0.0714  0.224

Gradient is taken with respect to the transformed paramter values.
Untransformed X: [ -0.1119208514441313, -0.23532520104750781, 0.4116883318819756, 0.1646961451565884, 0.33596828181760713, 0.13779583158900233]
X: [ -0.11239171262082137, -0.23981944552392548, 0.4376424051337831, 0.17110550057850926, 0.38687057827217475, 0.16411877695814805]
Gradient: [ 7.834179042951381E-5, -4.0110100708550915E-5, -6.76217835171726E-6, -3.5556663561273084E-5, -2.02413787704944E-5, -5.0116519979780295E-5]
Gradient type: numerical
Fx: 120.26202027956195
Time: 0.315s
Count: 1092
-->

    <!-- ************************************************** -->
    <!-- Diagonal -->

    <precisionGradient id="precisionDiagonalGradient" parameter="diagonal">
        <wishartStatistics  traitName="simTrait">
            <traitDataLikelihood idref="bmLikelihood"/>
        </wishartStatistics>
        <traitDataLikelihood idref="bmLikelihood"/>
        <cachedMatrixInverse idref="precisionMatrix"/>
    </precisionGradient>

    <logNormalPrior id="prior.diagonal" mean="0.0" stdev="1.0" offset="0.0" meanInRealSpace="false">
        <parameter idref="variance.diagonal"/>
    </logNormalPrior>

	<operators id="bmOperators.diagonal.hmcVanilla">
 		<hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
                                       drawVariance="1.0" gradientCheckCount="100" gradientCheckTolerance="0.5">
            <jointGradient>
                <gradient>
                    <logNormalPrior idref="prior.diagonal"/>
                    <parameter idref="variance.diagonal"/>
                </gradient>
                <gradient idref="precisionDiagonalGradient"/>
            </jointGradient>
            <parameter idref="variance.diagonal"/>
            <transform type="log"/>
 		</hamiltonianMonteCarloOperator>
	</operators>

	<operators id="bmOperators.diagonal.randomWalk">
        <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="variance.diagonal"/>
        </randomWalkOperator>
	</operators>

	<mcmc id="mcmc.diagonal.randomWalk" chainLength="1000000" autoOptimize="false">
		<posterior>
            <prior>
                <logNormalPrior idref="prior.diagonal"/>
            </prior>
            <likelihood id="likelihood.diagonal.randomWalk">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.diagonal.randomWalk"/>
		<log logEvery="10000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.diagonal.randomWalk"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <logNormalPrior idref="prior.diagonal"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="1000" fileName="testDiffusionDiagonalRandomWalk.log">
				<likelihood idref="likelihood.diagonal.randomWalk"/>
                <logNormalPrior idref="prior.diagonal"/>
                <matrixParameter idref="variance.diagonal"/>
		</log>
	</mcmc>



    <mcmc id="mcmc.diagonal.hmcVanilla" chainLength="100000" autoOptimize="false">
		<posterior>
            <prior>
                <logNormalPrior idref="prior.diagonal"/>
            </prior>
            <likelihood id="likelihood.diagonal.hmcVanilla">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.diagonal.hmcVanilla"/>
		<log logEvery="1000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.diagonal.hmcVanilla"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <logNormalPrior idref="prior.diagonal"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="100" fileName="testDiffusionDiagonalHmcVanilla.log">
				<likelihood idref="likelihood.diagonal.hmcVanilla"/>
                <logNormalPrior idref="prior.diagonal"/>
                <matrixParameter idref="variance.diagonal"/>
		</log>
	</mcmc>

	<report>
		<property name="timer">
			<object idref="mcmc.diagonal.randomWalk"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionDiagonalRandomWalk.log" stdError="true"/>

	<report>
		<property name="timer">
			<object idref="mcmc.diagonal.hmcVanilla"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionDiagonalHmcVanilla.log" stdError="true"/>

    <maximizeWrtParameter id="maximize.diagonal"  nIteration="100" printToScreen="true">
        <densityWrtParameter>
            <traitDataLikelihood idref="bmLikelihood"/>
            <paramter idref="variance.diagonal"/>
        </densityWrtParameter>
        <signTransform>
            <paramter idref="variance.diagonal"/>
        </signTransform>
    </maximizeWrtParameter>

    <report>
        <maximizeWrtParameter idref="maximize.diagonal"/>
    </report>

<!--
burnIn   <= 100000,   maxState  = 1000000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.diagonal.randomWalk  -121.3909   1.4243  -121.0392   -124.1367   -119.4138   653.7756    -121.2639   -119.8326   
prior.diagonal  -8.1225 0.6969  -8.1445 -9.4379 -6.7459 901 -8.6029 -7.6657 
variance.diagonal1  1.0555  0.2038  1.0369  0.6822  1.4565  714.1069    0.8798  1.1216  
variance.diagonal2  1.5641  0.3142  1.5249  1.0595  2.1926  901 1.2518  1.63    
variance.diagonal3  2.7955  0.5377  2.7037  1.8351  3.7749  880.6586    2.2338  2.8743  
variance.diagonal4  3.9839  0.7231  3.9021  2.7244  5.3969  858.3069    3.419   4.33    

burnIn   <= 10000,   maxState  = 100000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.diagonal.hmcVanilla  -121.3143   1.3855  -120.9584   -124.0233   -119.4229   654.0276    -121.078    -119.7584   
prior.diagonal  -8.1397 0.7018  -8.1381 -9.4916 -6.7464 901 -8.5949 -7.7532 
variance.diagonal1  1.0444  0.2001  1.0212  0.6633  1.4173  901 0.863   1.111   
variance.diagonal2  1.5714  0.3084  1.5267  1.1 2.2323  901 1.2893  1.6733  
variance.diagonal3  2.8103  0.5463  2.7337  1.9145  3.9659  901 2.3446  2.9903  
variance.diagonal4  4.0005  0.7254  3.9398  2.6901  5.3927  889.9014    3.4235  4.2745  

Gradient is taken with respect to the transformed paramter values.
Untransformed X: [ 1.020068591645332, 1.5483093910435606, 2.8030988411776523, 4.068280443171627]
X: [ 0.019869871746330925, 0.4371636202124041, 1.03072553420013, 1.4032204146428915]
Gradient: [ -1.926297395738426E-5, 2.578491421995093E-5, 2.811647535672739E-6, -5.779593362365016E-5]
Gradient type: numerical
Fx: 119.37775756796418
Time: 0.138s
Count: 513
-->

    <!-- ************************************************** -->
    <!-- Both -->

    <precisionGradient id="precisionBothGradient" parameter="both">
        <traitDataLikelihood idref="bmLikelihood"/>
        <cachedMatrixInverse idref="precisionMatrix"/>
    </precisionGradient>

    <compoundGradient id="priorGradient">
        <gradient>
            <logNormalPrior idref="prior.diagonal"/>
            <parameter idref="variance.diagonal"/>
        </gradient>
        <gradient>
            <LKJCorrelationPrior idref="prior.cholesky"/>
        </gradient>
    </compoundGradient>

    <report>
        <compoundGradient idref="priorGradient"/>
    </report>

    <report>
        <precisionGradient idref="precisionBothGradient"/>
    </report>

    <jointGradient id="post.precisionBothGradient">
        <precisionGradient idref="precisionBothGradient"/>
        <compoundGradient idref="priorGradient"/>
    </jointGradient>


    <operators id="bmOperators.both.hmcVanilla">
        <hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
                                       drawVariance="1.0" gradientCheckCount="100" gradientCheckTolerance="0.5">
            <gradient idref="post.precisionBothGradient"/>
            <compoundParameter id="try.me">
                <parameter idref="variance.diagonal"/>
                <parameter idref="variance.correlation"/>
            </compoundParameter>
            <multivariateCompoundTransform>
                <transform type="log" dim="4"/>
                <LKJTransform dimension="4"/>
            </multivariateCompoundTransform>
        </hamiltonianMonteCarloOperator>
    </operators>
	
<!-- 
	<operators id="bmOperators.both.hmcVanilla">
 		<hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
 			drawVariance="1.0">
 			<compoundGradient>
 				<gradient idref="precisionCorrelationGradient"/>
 				<gradient idref="precisionDiagonalGradient"/>
 			</compoundGradient>
 			 <compoundParameter>
 				<parameter idref="variance.correlation"/>
 				<parameter idref="variance.diagonal"/>
 			</compoundParameter>
 			<multivariateCompoundTransform>
 			    <LKJTransform dimension = "4"/>
 			    <transform type="log" dim = "4"/>
 			</multivariateCompoundTransform>
 		</hamiltonianMonteCarloOperator>
	</operators>
 -->
	
	<operators id="bmOperators.both.randomWalk">
	    <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="variance.diagonal"/>
        </randomWalkOperator>
        <randomWalkOperator windowSize="1.0" weight="1">
            <parameter idref="variance.correlation"/>
            <LKJTransform dimension = "4"/>
        </randomWalkOperator>
	</operators>


    <mcmc id="mcmc.both.randomWalk" chainLength="1000000" autoOptimize="false">
		<posterior>
            <prior>
                <LKJCorrelationPrior idref="prior.cholesky"/>
                <logNormalPrior idref="prior.diagonal"/>
            </prior>
            <likelihood id="likelihood.both.randomWalk">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.both.randomWalk"/>
		<log logEvery="10000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.diagonal.randomWalk"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <logNormalPrior idref="prior.diagonal"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="1000" fileName="testDiffusionBothRandomWalk.log">
				<likelihood idref="likelihood.both.randomWalk"/>
                <matrixParameter idref="varianceMatrix"/>
		</log>
	</mcmc>



	<mcmc id="mcmc.both.hmcVanilla" chainLength="100000" autoOptimize="false">
		<posterior>
            <prior>
                <LKJCorrelationPrior idref="prior.cholesky"/>
                <logNormalPrior idref="prior.diagonal"/>
            </prior>
            <likelihood id="likelihood.both.hmcVanilla">
                <traitDataLikelihood idref="bmLikelihood"/>
                <dummyLikelihood>
                    <parameter idref="varianceMatrix"/>
                </dummyLikelihood>
            </likelihood>
		</posterior>
		<operators idref="bmOperators.both.hmcVanilla"/>
		<log logEvery="1000">
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood.both.hmcVanilla"/>
			</column>
			<column label="Prior" dp="4" width="12">
                <logNormalPrior idref="prior.diagonal"/>
			</column>
			<column label="precision" dp="4" width="12">
                <matrixParameter idref="varianceMatrix"/>
			</column>
		</log>
		<log logEvery="100" fileName="testDiffusionBothHmcVanilla.log">
				<likelihood idref="likelihood.both.hmcVanilla"/>
                <matrixParameter idref="varianceMatrix"/>
		</log>
	</mcmc>

	<report>
		<property name="timer">
			<object idref="mcmc.both.randomWalk"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionBothRandomWalk.log" stdError="true"/>

	<report>
		<property name="timer">
			<object idref="mcmc.both.hmcVanilla"/>
		</property>
	</report>

	<traceAnalysis fileName="testDiffusionBothHmcVanilla.log" stdError="true"/>


<!--
burnIn   <= 100000,   maxState  = 1000000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.both.randomWalk  -124.0091   2.1426  -123.6752   -128.3673   -120.5664   901 -124.2116   -121.8208   
varianceMatrix00    1.0893  0.2243  1.0527  0.7106  1.5371  786.5136    0.893   1.1443  
varianceMatrix01    -0.1193 0.1853  -0.1147 -0.488  0.2433  874.2778    -0.1807 0.0505  
varianceMatrix02    -0.3594 0.2602  -0.3442 -0.9102 0.0956  846.9805    -0.4693 -0.1352 
varianceMatrix03    0.8461  0.3202  0.8096  0.2697  1.4861  742.7706    0.5549  0.9453  
varianceMatrix10    -0.1193 0.1853  -0.1147 -0.488  0.2433  874.2778    -0.1807 0.0505  
varianceMatrix11    1.6142  0.3195  1.5906  1.04    2.2489  901 1.3577  1.7494  
varianceMatrix12    0.2831  0.2994  0.2703  -0.3046 0.8609  879.3548    0.0854  0.4488  
varianceMatrix13    0.5916  0.3436  0.5589  -0.0555 1.2631  861.8195    0.3319  0.7473  
varianceMatrix20    -0.3594 0.2602  -0.3442 -0.9102 0.0956  846.9805    -0.4693 -0.1352 
varianceMatrix21    0.2831  0.2994  0.2703  -0.3046 0.8609  879.3548    0.0854  0.4488  
varianceMatrix22    2.892   0.5627  2.816   1.8086  3.9096  754.5597    2.3505  3.0494  
varianceMatrix23    0.2292  0.4486  0.2437  -0.5623 1.1192  901 -0.1162 0.4814  
varianceMatrix30    0.8461  0.3202  0.8096  0.2697  1.4861  742.7706    0.5549  0.9453  
varianceMatrix31    0.5916  0.3436  0.5589  -0.0555 1.2631  861.8195    0.3319  0.7473  
varianceMatrix32    0.2292  0.4486  0.2437  -0.5623 1.1192  901 -0.1162 0.4814  
varianceMatrix33    4.0742  0.8189  3.9443  2.8075  5.7082  802.6511    3.4037  4.4224  

burnIn   <= 10000,   maxState  = 100000
statistic   mean    stdErr  median  hpdLower    hpdUpper    ESS 50hpdLower  50hpdUpper
likelihood.both.hmcVanilla  -123.9139   2.0445  -123.5878   -127.7627   -120.5049   901 -124.6996   -122.2293   
varianceMatrix00    1.0858  0.2149  1.057   0.7309  1.5342  901 0.9001  1.1505  
varianceMatrix01    -0.1229 0.1865  -0.1131 -0.5058 0.235   901 -0.195  0.0263  
varianceMatrix02    -0.3677 0.2525  -0.3576 -0.9258 0.0644  901 -0.5135 -0.212  
varianceMatrix03    0.8428  0.2972  0.8218  0.3016  1.4604  871.2016    0.5908  0.9509  
varianceMatrix10    -0.1229 0.1865  -0.1131 -0.5058 0.235   901 -0.195  0.0263  
varianceMatrix11    1.6191  0.339   1.5632  1.0668  2.2878  901 1.2937  1.6684  
varianceMatrix12    0.2883  0.3081  0.2778  -0.2886 0.9052  901 0.0575  0.4373  
varianceMatrix13    0.5966  0.3364  0.5765  -0.0991 1.226   800.6107    0.3743  0.7961  
varianceMatrix20    -0.3677 0.2525  -0.3576 -0.9258 0.0644  901 -0.5135 -0.212  
varianceMatrix21    0.2883  0.3081  0.2778  -0.2886 0.9052  901 0.0575  0.4373  
varianceMatrix22    2.8928  0.6154  2.8454  1.7923  3.9713  901 2.459   3.1761  
varianceMatrix23    0.2372  0.443   0.2305  -0.6183 1.1471  665.5044    -0.0435 0.5213  
varianceMatrix30    0.8428  0.2972  0.8218  0.3016  1.4604  871.2016    0.5908  0.9509  
varianceMatrix31    0.5966  0.3364  0.5765  -0.0991 1.226   800.6107    0.3743  0.7961  
varianceMatrix32    0.2372  0.443   0.2305  -0.6183 1.1471  665.5044    -0.0435 0.5213  
varianceMatrix33    4.1089  0.7982  3.998   2.7513  5.5617  835.3966    3.3198  4.2635  
-->
</beast>

